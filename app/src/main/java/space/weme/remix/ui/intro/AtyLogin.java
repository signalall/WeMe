package space.weme.remix.ui.intro;import android.content.Intent;import android.content.SharedPreferences;import android.os.Bundle;import android.util.Log;import android.widget.Button;import android.widget.EditText;import android.widget.TextView;import android.widget.Toast;import butterknife.BindView;import butterknife.ButterKnife;import butterknife.OnClick;import rx.Subscription;import rx.android.schedulers.AndroidSchedulers;import rx.schedulers.Schedulers;import space.weme.remix.APP;import space.weme.remix.R;import space.weme.remix.service.Services;import space.weme.remix.service.UserService;import space.weme.remix.ui.base.BaseActivity;import space.weme.remix.ui.main.AtyMain;import space.weme.remix.util.StrUtils;import space.weme.remix.util.UpdateUtils;import space.weme.remix.widgt.LoadingView;/** * Created by Liujilong on 16/1/22. * liujilong.me@gmail.com */public class AtyLogin extends BaseActivity {    private final static String TAG = "AtyLogin";    public static final String INTENT_CLEAR = "intent_clear";    public static final String INTENT_UPDATE = "intent_update";    LoadingView mLoadingView;    @BindView(R.id.login_edit_text_user)    EditText mEtUser;    @BindView(R.id.login_edit_text_password)    EditText mEtPassword;    @BindView(R.id.login_button_login)    Button mBtnLogin;    @BindView(R.id.login_text_view_forget_password)    TextView mTvForget;    @BindView(R.id.login_text_view_register)    TextView mTvRegister;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.aty_login);        ButterKnife.bind(this);        if (getIntent().getBooleanExtra(INTENT_CLEAR, false)) {            Intent i = new Intent(AtyLogin.this, AtyMain.class);            startActivity(i);            finish();            return;        }        if (getIntent().getBooleanExtra(INTENT_UPDATE, false)) {            UpdateUtils.checkUpdate(AtyLogin.this);        }        mLoadingView = new LoadingView(this);    }    @Override    protected String tag() {        return TAG;    }    @OnClick(R.id.login_button_login)    public void onLoginClick() {        login();    }    @OnClick(R.id.login_text_view_forget_password)    public void onForgetPasswordClick() {        Intent i = new Intent(AtyLogin.this, AtyForget.class);        startActivity(i);    }    @OnClick(R.id.login_text_view_register)    public void onRegisterClick() {        Intent i = new Intent(AtyLogin.this, AtyRegister.class);        startActivity(i);    }    private void login() {        String username = mEtUser.getText().toString();        String passWord = mEtPassword.getText().toString();        if (username.isEmpty() || passWord.isEmpty()) {            Toast.makeText(this, R.string.account_or_password_not_null, Toast.LENGTH_SHORT).show();            return;        }        String passwordMd5 = StrUtils.md5(passWord);        Services.userService()                .login(new UserService.Login(username, passwordMd5))                .subscribeOn(Schedulers.io())                .observeOn(AndroidSchedulers.mainThread())                .subscribe(resp -> {                    Log.d(TAG, "login: " + resp.toString());                    if ("successful".equals(resp.getState())) {                        SharedPreferences sp = APP.context().getSharedPreferences(StrUtils.SP_USER, MODE_PRIVATE);                        sp.edit().putString(StrUtils.SP_USER_TOKEN, resp.getToken())                                .putString(StrUtils.SP_USER_ID, resp.getId())                                .putString(StrUtils.SP_USER_GENDER, resp.getGender()).apply();                        Toast.makeText(AtyLogin.this, R.string.login_success, Toast.LENGTH_SHORT).show();                        startActivity(new Intent(AtyLogin.this, AtyMain.class));                        finish();                    } else {                        Toast.makeText(AtyLogin.this,                                resp.getReason(),                                Toast.LENGTH_SHORT)                                .show();                    }                }, ex -> {                    Log.e(TAG, "login: " + ex.getMessage());                    Toast.makeText(AtyLogin.this,                            R.string.network_error,                            Toast.LENGTH_SHORT)                            .show();                });    }}